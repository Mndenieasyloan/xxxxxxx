<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Tracks - V0 Trade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: rgb(203 213 225);
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .sidebar-link:hover {
            background-color: rgb(168 85 247 / 0.1);
            color: rgb(168 85 247);
        }
        .sidebar-link.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            color: rgb(168 85 247);
            font-weight: 600;
        }
        
        /* Updated mobile sidebar behavior to use toggle button instead of hover */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 40;
                width: 240px;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            .sidebar-overlay.active {
                display: block;
            }
            .sidebar-toggle {
                display: flex;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar-toggle {
                display: none;
            }
        }
        
        .mobile-menu { display: none; }
        .mobile-menu.active { display: block; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: rgb(15 23 42 / 0.95); min-width: 12rem; border: 1px solid rgb(168 85 247 / 0.2); border-radius: 0.5rem; padding: 0.5rem; z-index: 1000; backdrop-filter: blur(10px); }
        .dropdown:hover .dropdown-content { display: block; }
        
        /* Mining plan cards */
        .plan-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .plan-card:hover {
            transform: translateY(-5px);
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 10px 25px rgba(168, 85, 247, 0.2);
        }
        
        .plan-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-micro { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-gold { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .badge-silver { background-color: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        .badge-diamond { background-color: rgba(6, 182, 212, 0.2); color: #06b6d4; }
        
        /* Progress bar */
        .progress-container {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        
        .progress-micro { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .progress-gold { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-silver { background: linear-gradient(90deg, #9ca3af, #d1d5db); }
        .progress-diamond { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        
        /* Chart containers */
        .chart-container {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        /* Transaction status */
        .status-active { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-completed { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-pending { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        
        .status-chip {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-950">
    
    <!-- Added hamburger toggle button for mobile -->
    <button onclick="toggleSidebar()" class="sidebar-toggle fixed left-4 top-20 z-50 bg-purple-500 hover:bg-purple-600 text-white p-2 rounded-lg shadow-lg transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
    </button>
    
    <!-- Added overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <header class="sticky top-0 z-50 border-b border-purple-500/20 bg-slate-950/80 backdrop-blur-md">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-4">
                <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition">
                    <div class="h-10 w-10">
                        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color: #a78bfa; stop-opacity: 1" />
                                    <stop offset="50%" style="stop-color: #ec4899; stop-opacity: 1" />
                                    <stop offset="100%" style="stop-color: #06b6d4; stop-opacity: 1" />
                                </linearGradient>
                            </defs>
                            <circle cx="100" cy="100" r="95" fill="url(#logoGradient)" opacity="0.2" />
                            <circle cx="100" cy="100" r="90" fill="none" stroke="url(#logoGradient)" stroke-width="2" />
                            <path d="M 50 60 L 80 140 M 150 60 L 120 140" stroke="url(#logoGradient)" stroke-width="8" stroke-linecap="round" fill="none" />
                            <circle cx="100" cy="100" r="25" fill="none" stroke="url(#logoGradient)" stroke-width="6" />
                        </svg>
                    </div>
                    <span class="text-xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 bg-clip-text text-transparent">V0 Trade</span>
                </a>

                <nav class="hidden items-center gap-8 md:flex">
                    <a href="index.html" class="text-sm text-gray-300 hover:text-white transition">Home</a>
                    <div class="dropdown">
                        <button class="text-sm text-gray-300 hover:text-white transition flex items-center gap-1">Invest <span>‚ñº</span></button>
                        <div class="dropdown-content">
                            <a href="cryptocurrencies.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">Cryptocurrencies</a>
                            <a href="precious-metals.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">Precious Metals</a>
                            <a href="stocks.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">Stocks</a>
                            <a href="etfs.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">ETFs</a>
                        </div>
                    </div>
                    <a href="btc-miner.html" class="text-sm text-gray-300 hover:text-white transition">BTC Miner</a>
                    <a href="about.html" class="text-sm text-gray-300 hover:text-white transition">About</a>
                    <a href="security.html" class="text-sm text-gray-300 hover:text-white transition">Security</a>
                    <div class="dropdown">
                        <button class="text-sm text-gray-300 hover:text-white transition flex items-center gap-1">Support <span>‚ñº</span></button>
                        <div class="dropdown-content">
                            <a href="contact.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">Contact Support</a>
                            <a href="faq.html" class="block px-3 py-2 text-sm text-gray-300 hover:text-white hover:bg-purple-500/10 rounded">FAQ</a>
                        </div>
                    </div>
                </nav>

                <div class="hidden items-center gap-4 md:flex">
                    <a href="dashboard.html" class="text-sm text-purple-400 hover:text-purple-300 transition">Dashboard</a>
                    <span class="text-sm text-gray-400" id="userEmailDisplay">user@email.com</span>
                    <a href="index.html" class="text-sm text-gray-300 hover:text-white transition">Logout</a>
                </div>

                <button class="md:hidden" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>

            <div id="mobileMenu" class="mobile-menu border-t border-purple-500/20 py-4 md:hidden">
                <nav class="flex flex-col gap-3">
                    <a href="index.html" class="text-sm text-gray-300 hover:text-white">Home</a>
                    <a href="cryptocurrencies.html" class="text-sm text-gray-300 hover:text-white">Cryptocurrencies</a>
                    <a href="precious-metals.html" class="text-sm text-gray-300 hover:text-white">Precious Metals</a>
                    <a href="stocks.html" class="text-sm text-gray-300 hover:text-white">Stocks</a>
                    <a href="etfs.html" class="text-sm text-gray-300 hover:text-white">ETFs</a>
                    <a href="btc-miner.html" class="text-sm text-gray-300 hover:text-white">BTC Miner</a>
                    <a href="about.html" class="text-sm text-gray-300 hover:text-white">About</a>
                    <a href="security.html" class="text-sm text-gray-300 hover:text-white">Security</a>
                    <a href="contact.html" class="text-sm text-gray-300 hover:text-white">Contact</a>
                    <a href="faq.html" class="text-sm text-gray-300 hover:text-white">FAQ</a>
                    <a href="dashboard.html" class="text-sm text-purple-400 hover:text-purple-300">Dashboard</a>
                    <a href="index.html" class="text-sm text-gray-300 hover:text-white">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="flex min-h-screen">
        <!-- Added id attribute for mobile toggle functionality -->
        <aside id="sidebar" class="sidebar w-64 bg-slate-900/50 border-r border-purple-500/20 p-4 backdrop-blur-sm">
            <div class="space-y-1 mb-6">
                <a href="deposit.html" class="sidebar-link">
                    <span>üí∞</span>
                    <span class="sidebar-text">Deposit</span>
                </a>
                <a href="withdraw.html" class="sidebar-link">
                    <span>üí∏</span>
                    <span class="sidebar-text">Withdraw</span>
                </a>
            </div>
            
            <div class="mb-6">
                <a href="dashboard.html" class="sidebar-link">
                    <span>üìä</span>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a href="coin-wallets.html" class="sidebar-link">
                    <span>ü™ô</span>
                    <span class="sidebar-text">Coin Wallets</span>
                </a>
                <a href="mining-tracks.html" class="sidebar-link active">
                    <span>‚õèÔ∏è</span>
                    <span class="sidebar-text">Mining Tracks</span>
                </a>
                <a href="investment-tracks.html" class="sidebar-link">
                    <span>üìà</span>
                    <span class="sidebar-text">Investment Tracks</span>
                </a>
            </div>

            <div class="mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase px-4 mb-2 sidebar-text">Report</p>
                <a href="referral-commissions.html" class="sidebar-link">
                    <span>üéÅ</span>
                    <span class="sidebar-text">Ref. Commissions</span>
                </a>
                <a href="deposit-history.html" class="sidebar-link">
                    <span>üì•</span>
                    <span class="sidebar-text">Deposit History</span>
                </a>
                <a href="order-history.html" class="sidebar-link">
                    <span>üìã</span>
                    <span class="sidebar-text">Order History</span>
                </a>
                <a href="withdrawals-log.html" class="sidebar-link">
                    <span>üì§</span>
                    <span class="sidebar-text">Withdrawals Log</span>
                </a>
                <a href="transactions.html" class="sidebar-link">
                    <span>üí≥</span>
                    <span class="sidebar-text">Transactions</span>
                </a>
            </div>

            <div>
                <p class="text-xs font-semibold text-gray-500 uppercase px-4 mb-2 sidebar-text">Support</p>
                <a href="open-ticket.html" class="sidebar-link">
                    <span>üé´</span>
                    <span class="sidebar-text">Open New Ticket</span>
                </a>
                <a href="support-tickets.html" class="sidebar-link">
                    <span>üì®</span>
                    <span class="sidebar-text">Support Tickets</span>
                </a>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-8">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">Mining Tracks</h1>
                        <p class="text-gray-400">Track your active mining plans and earnings in real-time</p>
                    </div>
                    <button onclick="refreshMiningData()" class="mt-4 md:mt-0 flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg text-sm font-medium transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh Data
                    </button>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-purple-500/20 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Active Plans</p>
                                <p id="activePlansCount" class="text-2xl font-bold text-white">0</p>
                            </div>
                            <div class="text-3xl">‚õèÔ∏è</div>
                        </div>
                        <p class="text-sm text-gray-400">Total mining plans</p>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-purple-500/20 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Total Investment</p>
                                <p id="totalInvestment" class="text-2xl font-bold text-white">$0</p>
                            </div>
                            <div class="text-3xl">üí∞</div>
                        </div>
                        <p class="text-sm text-gray-400">In mining plans</p>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-purple-500/20 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Estimated Returns</p>
                                <p id="estimatedReturns" class="text-2xl font-bold text-white">$0</p>
                            </div>
                            <div class="text-3xl">üìà</div>
                        </div>
                        <p class="text-sm text-gray-400">Projected earnings</p>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-sm rounded-xl border border-purple-500/20 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-sm text-gray-400 mb-1">Days Active</p>
                                <p id="daysActive" class="text-2xl font-bold text-white">0</p>
                            </div>
                            <div class="text-3xl">üìÖ</div>
                        </div>
                        <p class="text-sm text-gray-400">Mining duration</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Pie Chart: Mining Plan Distribution -->
                    <div class="chart-container slide-in">
                        <h3 class="text-lg font-semibold text-white mb-4">Mining Plan Distribution</h3>
                        <div class="h-64">
                            <canvas id="planDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Line Chart: Earnings Trend -->
                    <div class="chart-container slide-in">
                        <h3 class="text-lg font-semibold text-white mb-4">Daily Earnings Trend</h3>
                        <div class="h-64">
                            <canvas id="earningsTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Candlestick Chart: Performance -->
                    <div class="chart-container slide-in lg:col-span-2">
                        <h3 class="text-lg font-semibold text-white mb-4">Mining Performance Analytics</h3>
                        <div class="h-80">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Active Mining Plans -->
                <div id="activeMiningPlans" class="mb-8">
                    <h2 class="text-xl font-bold text-white mb-6">Active Mining Plans</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="miningPlansContainer">
                        <!-- Mining plans will be loaded here -->
                    </div>
                </div>

                <!-- No Mining Plans Message -->
                <div id="noMiningPlansMessage" class="bg-slate-900/80 backdrop-blur-sm rounded-xl border border-purple-500/20 p-8 text-center mb-8">
                    <div class="text-6xl mb-4 pulse-animation">‚õèÔ∏è</div>
                    <h2 class="text-2xl font-semibold text-white mb-4">No Active Mining Plans</h2>
                    <p class="text-gray-400 mb-6">Start mining Bitcoin today with our AI-powered cloud mining platform</p>
                    <a href="btc-miner.html" class="inline-block bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white px-8 py-3 rounded-lg font-semibold transition">
                        Browse Mining Plans
                    </a>
                </div>

                <!-- Mining Transactions History -->
                <div class="chart-container slide-in">
                    <h3 class="text-lg font-semibold text-white mb-4">Mining Transactions History</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-400">Plan</th>
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-400">Investment</th>
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-400">Start Date</th>
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-400">Status</th>
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-400">Progress</th>
                                </tr>
                            </thead>
                            <tbody id="miningTransactionsTable">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noTransactionsMessage" class="text-center py-8">
                        <p class="text-gray-500">No mining transactions found</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Constants for localStorage keys (must match dashboard)
        const TRANSACTIONS_DATA_KEY = "v0trade_transactions_data";
        
        // Mining plans configuration
        const MINING_PLANS = {
            'Micro Plan btc miner': {
                name: 'Micro Plan',
                investment: 600,
                duration: 3,
                hashrate: '130 TH/s',
                dailyReturn: 36,
                maintenance: 0,
                color: '#3b82f6',
                badgeClass: 'badge-micro',
                progressClass: 'progress-micro'
            },
            'Gold plan btc miner': {
                name: 'Gold Plan',
                investment: 1850,
                duration: 6,
                hashrate: '720 TH/s',
                dailyReturn: 48,
                maintenance: 0,
                color: '#f59e0b',
                badgeClass: 'badge-gold',
                progressClass: 'progress-gold'
            },
            'Silver Plan btc miner': {
                name: 'Silver Plan',
                investment: 2450,
                duration: 13,
                hashrate: '2,114 TH/s',
                dailyReturn: 40,
                maintenance: 0,
                color: '#9ca3af',
                badgeClass: 'badge-silver',
                progressClass: 'progress-silver'
            },
            'Diamond Plan btc miner': {
                name: 'Diamond Plan',
                investment: 2200,
                duration: 7,
                hashrate: '3,288 TH/s',
                dailyReturn: 80,
                maintenance: 0,
                color: '#06b6d4',
                badgeClass: 'badge-diamond',
                progressClass: 'progress-diamond'
            }
        };

        // Chart instances
        let planDistributionChart = null;
        let earningsTrendChart = null;
        let performanceChart = null;

        window.addEventListener('DOMContentLoaded', function() {
            const userEmail = localStorage.getItem("v0trade_user_email");
            
            if (!userEmail) {
                alert("Please login to access this page.");
                window.location.href = "login.html";
                return;
            }

            // Update header with user email
            const emailDisplay = document.getElementById('userEmailDisplay');
            if (emailDisplay) {
                emailDisplay.textContent = userEmail;
            }

            loadMiningData(userEmail);
            initializeCharts();
        });

        function loadMiningData(email) {
            try {
                // Get cached transactions from localStorage
                const cachedData = localStorage.getItem(`${TRANSACTIONS_DATA_KEY}_${email}`);
                
                if (!cachedData) {
                    showNoMiningPlans();
                    updateSummaryStats([]);
                    return;
                }
                
                const allTransactions = JSON.parse(cachedData);
                
                // Filter to get only mining plan transactions
                const miningTransactions = allTransactions.filter(transaction => {
                    const method = transaction.method?.toLowerCase() || '';
                    return Object.keys(MINING_PLANS).some(plan => 
                        method.includes(plan.toLowerCase())
                    );
                });
                
                console.log("Mining transactions found:", miningTransactions);
                
                if (miningTransactions.length === 0) {
                    showNoMiningPlans();
                    updateSummaryStats([]);
                    return;
                }
                
                // Process mining transactions
                const miningPlans = processMiningPlans(miningTransactions);
                
                // Display mining plans
                displayMiningPlans(miningPlans);
                
                // Update summary statistics
                updateSummaryStats(miningPlans);
                
                // Update charts
                updateCharts(miningPlans);
                
                // Display transactions table
                displayMiningTransactions(miningTransactions);
                
            } catch (err) {
                console.error("Error loading mining data:", err);
                showNoMiningPlans();
            }
        }
        
        function processMiningPlans(transactions) {
            const plans = {};
            
            transactions.forEach(transaction => {
                const method = transaction.method || '';
                const planKey = Object.keys(MINING_PLANS).find(plan => 
                    method.toLowerCase().includes(plan.toLowerCase())
                );
                
                if (planKey && MINING_PLANS[planKey]) {
                    const plan = MINING_PLANS[planKey];
                    const amount = parseFloat(transaction.amount) || 0;
                    const transactionDate = new Date(transaction.date);
                    
                    if (!plans[planKey]) {
                        plans[planKey] = {
                            ...plan,
                            totalInvestment: 0,
                            transactionCount: 0,
                            transactions: [],
                            startDate: transactionDate
                        };
                    }
                    
                    plans[planKey].totalInvestment += amount;
                    plans[planKey].transactionCount++;
                    plans[planKey].transactions.push({
                        id: transaction.id,
                        amount: amount,
                        date: transactionDate,
                        status: transaction.status || 'active'
                    });
                    
                    // Update earliest start date
                    if (transactionDate < plans[planKey].startDate) {
                        plans[planKey].startDate = transactionDate;
                    }
                }
            });
            
            return Object.values(plans);
        }
        
        function displayMiningPlans(plans) {
            const container = document.getElementById('miningPlansContainer');
            const noPlansDiv = document.getElementById('noMiningPlansMessage');
            const activePlansDiv = document.getElementById('activeMiningPlans');
            
            if (plans.length === 0) {
                activePlansDiv.style.display = 'none';
                noPlansDiv.style.display = 'block';
                return;
            }
            
            activePlansDiv.style.display = 'block';
            noPlansDiv.style.display = 'none';
            
            container.innerHTML = '';
            
            plans.forEach((plan, index) => {
                const daysSinceStart = Math.floor((new Date() - plan.startDate) / (1000 * 60 * 60 * 24));
                const progressPercentage = Math.min(100, (daysSinceStart / plan.duration) * 100);
                const isCompleted = daysSinceStart >= plan.duration;
                const estimatedReturns = (plan.totalInvestment * (plan.dailyReturn / 100) * plan.duration).toFixed(2);
                
                const planCard = document.createElement('div');
                planCard.className = 'plan-card slide-in';
                planCard.style.animationDelay = `${index * 0.1}s`;
                
                planCard.innerHTML = `
                    <span class="plan-badge ${plan.badgeClass}">${plan.name}</span>
                    
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-white mb-2">${plan.name}</h3>
                        <p class="text-gray-400 text-sm">${plan.hashrate} | ${plan.duration} Days</p>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Investment:</span>
                            <span class="text-white font-semibold">$${plan.totalInvestment.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Daily Return:</span>
                            <span class="text-green-400 font-semibold">${plan.dailyReturn}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Est. Returns:</span>
                            <span class="text-yellow-400 font-semibold">$${estimatedReturns}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Progress</span>
                            <span class="text-white">${Math.round(progressPercentage)}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar ${plan.progressClass}" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Day ${daysSinceStart}</span>
                            <span>of ${plan.duration}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="status-chip ${isCompleted ? 'status-completed' : 'status-active'}">
                            ${isCompleted ? 'Completed' : 'Active'}
                        </span>
                        <button onclick="viewPlanDetails('${plan.name}')" class="text-sm bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg transition">
                            Details
                        </button>
                    </div>
                `;
                
                container.appendChild(planCard);
            });
        }
        
        function updateSummaryStats(plans) {
            let totalInvestment = 0;
            let totalEstimatedReturns = 0;
            let totalDaysActive = 0;
            
            plans.forEach(plan => {
                totalInvestment += plan.totalInvestment;
                const planReturns = plan.totalInvestment * (plan.dailyReturn / 100) * plan.duration;
                totalEstimatedReturns += planReturns;
                
                const daysSinceStart = Math.floor((new Date() - plan.startDate) / (1000 * 60 * 60 * 24));
                totalDaysActive += Math.min(daysSinceStart, plan.duration);
            });
            
            document.getElementById('activePlansCount').textContent = plans.length;
            document.getElementById('totalInvestment').textContent = `$${totalInvestment.toFixed(2)}`;
            document.getElementById('estimatedReturns').textContent = `$${totalEstimatedReturns.toFixed(2)}`;
            document.getElementById('daysActive').textContent = totalDaysActive;
        }
        
        function initializeCharts() {
            // Initialize charts with empty data
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        borderColor: '#a855f7',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    }
                }
            };
            
            // Plan Distribution Pie Chart
            const planCtx = document.getElementById('planDistributionChart').getContext('2d');
            planDistributionChart = new Chart(planCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderColor: 'rgba(15, 23, 42, 0.8)',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        datalabels: {
                            color: '#ffffff',
                            formatter: (value, ctx) => {
                                return ctx.chart.data.labels[ctx.dataIndex];
                            }
                        }
                    }
                }
            });
            
            // Earnings Trend Line Chart
            const earningsCtx = document.getElementById('earningsTrendChart').getContext('2d');
            earningsTrendChart = new Chart(earningsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Earnings',
                        data: [],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
            
            // Performance Bar Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Investment',
                            data: [],
                            backgroundColor: 'rgba(168, 85, 247, 0.7)',
                            borderColor: 'rgba(168, 85, 247, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Returns',
                            data: [],
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        x: {
                            ...chartOptions.scales.x,
                            stacked: true
                        },
                        y: {
                            ...chartOptions.scales.y,
                            stacked: false,
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateCharts(plans) {
            if (plans.length === 0) return;
            
            // Update Plan Distribution Chart
            const planLabels = plans.map(p => p.name);
            const planInvestments = plans.map(p => p.totalInvestment);
            const planColors = plans.map(p => p.color);
            
            planDistributionChart.data.labels = planLabels;
            planDistributionChart.data.datasets[0].data = planInvestments;
            planDistributionChart.data.datasets[0].backgroundColor = planColors;
            planDistributionChart.update();
            
            // Update Earnings Trend Chart
            const days = 7;
            const earningsData = [];
            const dates = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                
                let dailyEarnings = 0;
                plans.forEach(plan => {
                    const daysSinceStart = Math.floor((date - plan.startDate) / (1000 * 60 * 60 * 24));
                    if (daysSinceStart >= 0 && daysSinceStart < plan.duration) {
                        dailyEarnings += plan.totalInvestment * (plan.dailyReturn / 100);
                    }
                });
                earningsData.push(dailyEarnings);
            }
            
            earningsTrendChart.data.labels = dates;
            earningsTrendChart.data.datasets[0].data = earningsData;
            earningsTrendChart.update();
            
            // Update Performance Chart
            const performanceLabels = plans.map(p => p.name);
            const investments = plans.map(p => p.totalInvestment);
            const returns = plans.map(p => p.totalInvestment * (p.dailyReturn / 100) * p.duration);
            
            performanceChart.data.labels = performanceLabels;
            performanceChart.data.datasets[0].data = investments;
            performanceChart.data.datasets[1].data = returns;
            performanceChart.update();
        }
        
        function displayMiningTransactions(transactions) {
            const container = document.getElementById('miningTransactionsTable');
            const noTransactionsDiv = document.getElementById('noTransactionsMessage');
            
            if (transactions.length === 0) {
                container.innerHTML = '';
                noTransactionsDiv.style.display = 'block';
                return;
            }
            
            noTransactionsDiv.style.display = 'none';
            container.innerHTML = '';
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only recent transactions
            const recentTransactions = transactions.slice(0, 5);
            
            recentTransactions.forEach(transaction => {
                const method = transaction.method || '';
                const planKey = Object.keys(MINING_PLANS).find(plan => 
                    method.toLowerCase().includes(plan.toLowerCase())
                );
                const plan = planKey ? MINING_PLANS[planKey] : null;
                
                const transactionDate = new Date(transaction.date);
                const daysSinceStart = Math.floor((new Date() - transactionDate) / (1000 * 60 * 60 * 24));
                const progressPercentage = plan ? Math.min(100, (daysSinceStart / plan.duration) * 100) : 0;
                const isCompleted = plan && daysSinceStart >= plan.duration;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-800 hover:bg-slate-800/50 transition';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${plan ? plan.color : '#9ca3af'}"></span>
                            <span class="text-white">${plan ? plan.name : method}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-white font-semibold">$${parseFloat(transaction.amount || 0).toFixed(2)}</td>
                    <td class="py-3 px-4 text-gray-400">${transactionDate.toLocaleDateString()}</td>
                    <td class="py-3 px-4">
                        <span class="status-chip ${isCompleted ? 'status-completed' : 'status-active'}">
                            ${isCompleted ? 'Completed' : 'Active'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        ${plan ? `
                        <div class="flex items-center gap-2">
                            <div class="w-24 h-2 bg-gray-700 rounded-full overflow-hidden">
                                <div class="h-full ${plan.progressClass}" style="width: ${progressPercentage}%"></div>
                            </div>
                            <span class="text-sm text-gray-400">${Math.round(progressPercentage)}%</span>
                        </div>
                        ` : 'N/A'}
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        function showNoMiningPlans() {
            document.getElementById('noMiningPlansMessage').style.display = 'block';
            document.getElementById('activeMiningPlans').style.display = 'none';
            document.getElementById('noTransactionsMessage').style.display = 'block';
        }
        
        function viewPlanDetails(planName) {
            alert(`Viewing details for ${planName}\nThis would show detailed analytics and performance metrics.`);
        }
        
        function refreshMiningData() {
            const userEmail = localStorage.getItem("v0trade_user_email");
            if (!userEmail) return;
            
            // Show loading state
            const refreshBtn = document.querySelector('button[onclick="refreshMiningData()"]');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = 'üîÑ Refreshing...';
            refreshBtn.disabled = true;
            
            // Simulate refresh
            setTimeout(() => {
                loadMiningData(userEmail);
                
                // Restore button
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
                
                // Show success indicator
                refreshBtn.innerHTML = '‚úì Refreshed';
                refreshBtn.classList.remove('from-purple-500', 'to-pink-500');
                refreshBtn.classList.add('from-green-500', 'to-emerald-500');
                
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.classList.remove('from-green-500', 'to-emerald-500');
                    refreshBtn.classList.add('from-purple-500', 'to-pink-500');
                }, 2000);
            }, 1500);
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('active');
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
    </script>

</body>
</html>
