<script>
    const DEPOSIT_API = "https://api.baserow.io/api/database/rows/table/756078/";
    const FILE_UPLOAD_API = "https://api.baserow.io/api/user-files/upload-file/";
    const BASEROW_TOKEN = "LG6hnTBxgBG78FueElsSwpHRd4Wep1oL";
    
    let currentUserEmail = '';
    let proofFile = null;

    // Check if user is logged in
    function checkAuth() {
        const userEmail = localStorage.getItem("v0trade_user_email");
        console.log('[USDT Deposit] Checking auth - user email:', userEmail);
        
        if (!userEmail) {
            console.log('[USDT Deposit] No user logged in - allowing access');
            return null;
        }
        
        return userEmail;
    }

    // Update header email display
    function updateHeaderEmail(email) {
        const headerEmailElements = document.querySelectorAll('#headerEmailDisplay, .user-email-display');
        headerEmailElements.forEach(element => {
            if (element) {
                element.textContent = email;
            }
        });
    }

    // Auto-fill email if user is logged in
    function autoFillUserEmail() {
        if (currentUserEmail) {
            const emailInput = document.getElementById('userEmail');
            if (emailInput) {
                emailInput.value = currentUserEmail;
                emailInput.readOnly = true;
                emailInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            }
        }
    }

    // File upload handling
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            validateAndSetFile(file);
        }
    }

    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.getElementById('fileUploadContainer');
        container.classList.remove('dragover');
        
        const file = event.dataTransfer.files[0];
        if (file) {
            validateAndSetFile(file);
        }
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        const container = document.getElementById('fileUploadContainer');
        container.classList.add('dragover');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        const container = document.getElementById('fileUploadContainer');
        container.classList.remove('dragover');
    }

    function validateAndSetFile(file) {
        // Check file size (5MB max)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File is too large. Maximum size is 5MB.');
            return;
        }

        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
        if (!validTypes.includes(file.type)) {
            alert('Please upload a valid image or PDF file.');
            return;
        }

        proofFile = file;
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileError').classList.add('hidden');

        // Show preview for images
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.add('show');
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('imagePreview').classList.remove('show');
        }
    }

    // Upload file to Baserow and get file ID
    async function uploadFileToBaserow(file) {
        console.log('[USDT Deposit] Starting file upload...');
        
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(FILE_UPLOAD_API, {
                method: 'POST',
                headers: {
                    'Authorization': 'Token ' + BASEROW_TOKEN
                },
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[USDT Deposit] File upload failed:', errorText);
                throw new Error(`File upload failed: ${response.status}`);
            }

            const result = await response.json();
            console.log('[USDT Deposit] File uploaded successfully:', result);
            
            // Return just the file name/ID for the file field
            return {
                name: result.name,
                size: result.size,
                mime_type: result.mime_type,
                uploaded_at: result.uploaded_at
            };
            
        } catch (error) {
            console.error('[USDT Deposit] File upload error:', error);
            throw error;
        }
    }

    // Send deposit data to Baserow with CORRECT field format
    async function sendDepositToBaserow(depositData) {
        console.log('[USDT Deposit] Sending deposit data to Baserow:', depositData);
        
        try {
            // TRY METHOD 1: Without user_field_names parameter
            let response = await fetch(DEPOSIT_API, {
                method: "POST",
                headers: {
                    "Authorization": "Token " + BASEROW_TOKEN,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(depositData)
            });

            console.log('[USDT Deposit] Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('[USDT Deposit] Method 1 failed:', errorText);
                
                // TRY METHOD 2: With user_field_names=false (field IDs)
                const fieldIdPayload = {
                    "6394426": depositData.email,
                    "6394427": depositData.method,
                    "6394428": depositData.amount,
                    "6394429": depositData.pin,
                    "6394430": depositData.wallet_address,
                    "6394431": depositData.status,
                    "6394432": depositData.transaction_id,
                    "6394433": depositData.timestamp,
                    "6445160": depositData.image
                };
                
                console.log('[USDT Deposit] Trying Method 2 with field IDs:', fieldIdPayload);
                
                response = await fetch(DEPOSIT_API, {
                    method: "POST",
                    headers: {
                        "Authorization": "Token " + BASEROW_TOKEN,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(fieldIdPayload)
                });
                
                if (!response.ok) {
                    const errorText2 = await response.text();
                    console.error('[USDT Deposit] Method 2 failed:', errorText2);
                    
                    // TRY METHOD 3: With user_field_names=true
                    response = await fetch(DEPOSIT_API + '?user_field_names=true', {
                        method: "POST",
                        headers: {
                            "Authorization": "Token " + BASEROW_TOKEN,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(depositData)
                    });
                    
                    if (!response.ok) {
                        const errorText3 = await response.text();
                        console.error('[USDT Deposit] All methods failed:', errorText3);
                        throw new Error(`All API methods failed. Last status: ${response.status}`);
                    }
                }
            }

            const result = await response.json();
            console.log('[USDT Deposit] Baserow response successful:', result);
            return result;
            
        } catch (error) {
            console.error('[USDT Deposit] Error sending to Baserow:', error);
            throw error;
        }
    }

    async function confirmPayment() {
        const emailInput = document.getElementById('userEmail');
        const email = emailInput.value.trim();
        const amount = localStorage.getItem('deposit_amount') || '0.00';
        const usdtWallet = document.getElementById('usdtWallet').textContent;

        // Validate required fields
        if (!email) {
            alert('Please enter your email address');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert('Please enter a valid email address');
            return;
        }

        if (!proofFile) {
            document.getElementById('fileError').classList.remove('hidden');
            alert('Please upload proof of payment screenshot');
            return;
        }

        const confirmBtn = document.getElementById('confirmBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Processing...';

        try {
            console.log('[USDT Deposit] Starting deposit process...');
            console.log('[USDT Deposit] Data collected:');
            console.log('- Email:', email);
            console.log('- Amount:', amount);
            console.log('- Method: USDT');
            console.log('- Wallet:', usdtWallet);
            
            // 1. Upload file to Baserow
            console.log('[USDT Deposit] Uploading proof file...');
            const uploadedFileData = await uploadFileToBaserow(proofFile);
            console.log('[USDT Deposit] File uploaded data:', uploadedFileData);
            
            // 2. Generate transaction ID and timestamp
            const transactionId = 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            const timestamp = new Date().toISOString();

            // 3. Prepare data in different formats to try
            const depositData = {
                email: email,
                method: 'USDT',
                amount: amount,
                pin: 'N/A',
                wallet_address: usdtWallet,
                status: 'pending',
                transaction_id: transactionId,
                timestamp: timestamp,
                image: [uploadedFileData.name]  // Try with just file name array
            };

            console.log('[USDT Deposit] Prepared deposit data:', depositData);

            // 4. Send data to Baserow
            console.log('[USDT Deposit] Sending to Baserow API...');
            const baserowResponse = await sendDepositToBaserow(depositData);
            
            console.log('[USDT Deposit] Baserow created row:', baserowResponse);
            console.log('[USDT Deposit] Row ID:', baserowResponse.id);

            // 5. Save to localStorage as backup
            const localDepositData = {
                id: transactionId,
                type: 'deposit',
                method: 'USDT',
                amount: amount,
                email: email,
                wallet: usdtWallet,
                status: 'pending',
                timestamp: timestamp,
                proofFile: {
                    name: proofFile.name,
                    size: proofFile.size,
                    type: proofFile.type,
                    lastModified: proofFile.lastModified,
                    baserowFileData: uploadedFileData
                },
                baserowId: baserowResponse.id,
                expiry: Date.now() + (24 * 60 * 60 * 1000)
            };

            // Save to transactions array
            const existingTransactions = JSON.parse(localStorage.getItem('latest_transactions') || '[]');
            existingTransactions.unshift(localDepositData);
            const limitedTransactions = existingTransactions.slice(0, 10);
            localStorage.setItem('latest_transactions', JSON.stringify(limitedTransactions));
            
            // Save individual details
            localStorage.setItem('deposit_method', 'USDT');
            localStorage.setItem('deposit_amount', amount);
            localStorage.setItem('deposit_wallet_address', usdtWallet);
            localStorage.setItem('deposit_email', email);
            localStorage.setItem('transaction_id', transactionId);
            localStorage.setItem('deposit_timestamp', timestamp);
            localStorage.setItem('deposit_status', 'pending');
            localStorage.setItem('deposit_baserow_id', baserowResponse.id);
            localStorage.setItem('deposit_proof_file', JSON.stringify(localDepositData.proofFile));

            console.log('[USDT Deposit] Data saved to localStorage');

            // 6. Show success and redirect
            alert('âœ… Deposit submitted successfully!\nTransaction ID: ' + transactionId + '\nYou will be redirected to the payment pending page.');
            
            setTimeout(() => {
                window.location.href = 'payment-pending.html';
            }, 1500);

        } catch (error) {
            console.error('[USDT Deposit] Error processing deposit:', error);
            
            // Try alternative: Simple POST without file upload first
            if (error.message.includes('All API methods failed')) {
                console.log('[USDT Deposit] Trying simple POST...');
                
                try {
                    // Simple test payload
                    const testPayload = {
                        "field_6394426": email,
                        "field_6394427": "USDT",
                        "field_6394428": amount,
                        "field_6394429": "N/A",
                        "field_6394430": usdtWallet,
                        "field_6394431": "pending",
                        "field_6394432": "TXN-TEST-" + Date.now(),
                        "field_6394433": new Date().toISOString(),
                        "field_6445160": ["test_file.jpg"]
                    };
                    
                    const testResponse = await fetch(DEPOSIT_API, {
                        method: "POST",
                        headers: {
                            "Authorization": "Token " + BASEROW_TOKEN,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(testPayload)
                    });
                    
                    if (testResponse.ok) {
                        const testResult = await testResponse.json();
                        console.log('[USDT Deposit] Simple test succeeded:', testResult);
                        alert('Deposit submitted (test mode). Please check Baserow.');
                    } else {
                        const testError = await testResponse.text();
                        console.error('[USDT Deposit] Simple test failed:', testError);
                        alert('Failed to submit deposit. Please check console for details and contact support.');
                    }
                } catch (testError) {
                    console.error('[USDT Deposit] Test also failed:', testError);
                    alert('Deposit system error. Please contact support with error details.');
                }
            } else {
                alert('Deposit submission error: ' + error.message);
            }
            
            // Re-enable button
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Payment';
        }
    }

    // Navigation functions
    function toggleMobileMenu() {
        const menu = document.getElementById('mobileMenu');
        if (menu) {
            menu.classList.toggle('active');
        }
    }
    
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if (sidebar && overlay) {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
    }

    // Clean up expired transactions
    function cleanupExpiredTransactions() {
        try {
            const transactions = JSON.parse(localStorage.getItem('latest_transactions') || '[]');
            const now = Date.now();
            const validTransactions = transactions.filter(tx => tx.expiry > now);
            localStorage.setItem('latest_transactions', JSON.stringify(validTransactions));
        } catch (error) {
            console.error('[USDT Deposit] Error cleaning up transactions:', error);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        const userEmail = checkAuth();
        currentUserEmail = userEmail || '';
        
        if (currentUserEmail) {
            updateHeaderEmail(currentUserEmail);
        }

        const amount = localStorage.getItem('deposit_amount') || '0.00';
        document.getElementById('requestedAmount').textContent = `$${amount} USD`;
        document.getElementById('payAmount').textContent = `$${amount} USD worth of USDT`;
        document.getElementById('reminderAmount').textContent = `$${amount} USD`;

        autoFillUserEmail();
        cleanupExpiredTransactions();
    });
</script>
